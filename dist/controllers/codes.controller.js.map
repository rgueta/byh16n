{"version":3,"sources":["../../src/controllers/codes.controller.js"],"names":["createCode","req","res","console","log","body","code","initial","expiry","comment","visitorId","source","user","platform","id","newCode","Codes","productSaved","save","status","json","getCodes","codes","aggregate","$lookup","from","localField","foreignField","as","$sort","$project","codeId","created","enable","userId","userName","email","avatar","visitorname","visitorsim","getCodesByUser","params","$match","$eq","Types","ObjectId","visitorName","visitorSim","getCodeById","findById","updateCodeById","JSON","stringify","updatedCode","findByIdAndUpdate","new","deleteCodeById","deletedCode","findByIdAndDelete"],"mappings":"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","sourcesContent":["import Codes  from \"../models/codes\";\r\nimport { Types } from \"mongoose\";\r\n\r\nexport const createCode = async (req,res) => {\r\n    console.log('createCode req body --> ',req.body);\r\n    // return\r\n    const { code,initial,expiry,comment,visitorId,source :{user,platform, id}} = req.body;\r\n    // const parameters = req.body\r\n    // console.log('parameters --> ',parameters.source.user);\r\n    \r\n    \r\n    // const userId = Types.ObjectId(req.body.source.user);\r\n    // const visitorId = Types.ObjectId(req.body.visitorId);\r\n    // console.log('params --> ',userId,visitorId)\r\n    // return\r\n    const newCode = new Codes({code,initial,expiry,comment,visitorId,\r\n        source: {user,platform,id }});\r\n    const productSaved = await newCode.save();\r\n    \r\n   \r\n    // console.log(req.body);\r\n    res.status(201).json(productSaved);\r\n}\r\n\r\nexport const getCodes = async (req,res) => {\r\n\r\n    const codes = await Codes.aggregate([\r\n        {\r\n            $lookup:{\r\n                    from : 'users',\r\n                    localField : \"source.user\",\r\n                    foreignField : '_id',\r\n                    as :  'code_users'\r\n                    }\r\n            },\r\n            {\r\n            $lookup:{\r\n                    from : 'visitors',\r\n                    localField : 'visitorId',\r\n                    foreignField : '_id',\r\n                    as :  'codes_visitors'\r\n                    }\r\n            },\r\n            {'$unwind' : '$code_users'},\r\n            {'$unwind' : '$codes_visitors'},\r\n            {$sort : {expiry : -1}},\r\n            {\r\n               $project:{\r\n                       codeId : 1,\r\n                       code: 1,\r\n                       created : 1,\r\n                       initial : 1,\r\n                       expiry : 1,\r\n                       enable:1,\r\n                       userId : '$code_users._id',\r\n                       userName : '$code_users.name',\r\n                       email : '$code_users.email',\r\n                       avatar : '$code_users.Avatar',\r\n                       visitorname: '$codes_visitors.name',\r\n                       visitorsim: '$codes_visitors.sim'\r\n                       }\r\n               }\r\n    ])\r\n    res.json(codes);\r\n}\r\n\r\nexport const getCodesByUser = async (req,res) => {\r\n    console.log('get Code events');\r\n    if(req.params.userId != 'null'){\r\n        console.log('get Code by user: ' + req.params.userId);\r\n        // const user = new ObjectId(req.params.userId);\r\n        const codes = await Codes.aggregate([\r\n            {$sort : {expiry : -1}},\r\n            {\r\n                $lookup:{\r\n                        from : 'users',\r\n                        localField : \"source.user\",\r\n                        foreignField : '_id',\r\n                        as :  'code_users'\r\n                        }\r\n                },\r\n                {\r\n                $lookup:{\r\n                        from : 'visitors',\r\n                        localField : 'visitorId',\r\n                        foreignField : '_id',\r\n                        as :  'codes_visitors'\r\n                        }\r\n                },\r\n                {'$unwind' : '$code_users'},\r\n                {'$unwind' : '$codes_visitors'},\r\n                {\r\n                    $match:{\r\n                        'code_users._id' : { $eq : Types.ObjectId(req.params.userId)}\r\n                    }\r\n                },\r\n                {\r\n                $project:{\r\n                        codeId : 1,\r\n                        code: 1,\r\n                        created : 1,\r\n                        initial : 1,\r\n                        expiry : 1,\r\n                        enable:1,\r\n                        userId : '$code_users._id',\r\n                        userName : '$code_users.name',\r\n                        email : '$code_users.email',\r\n                        avatar : '$code_users.Avatar',\r\n                        visitorName: '$codes_visitors.name',\r\n                        visitorSim: '$codes_visitors.sim'\r\n                        }\r\n                }\r\n        ])\r\n\r\n\r\n        res.json(codes);\r\n    }else{\r\n        console.log({'Error':'userId missing '});\r\n        res.status(201).json({'Error':'userId missing '});\r\n    }\r\n}\r\n\r\nexport const getCodeById = async (req,res) => {\r\n    const code = await Codes.findById(req.params.codeId);\r\n    console.log(req.params.codeId);\r\n    res.status(200).json(code);\r\n}\r\n\r\nexport const updateCodeById = async (req,res) => {\r\n    console.log('(req.params.codeId --> ' + req.params.codeId);\r\n    console.log('pkg to update --> ' + JSON.stringify(req.body))\r\n    const updatedCode = await Codes.findByIdAndUpdate(req.params.codeId,req.body,{new:true});\r\n    console.log('updatedCode -> ', updatedCode);\r\n    res.status(200).json(updatedCode);    \r\n}\r\n\r\nexport const deleteCodeById = async (req,res) => {\r\n    const deletedCode = await Codes.findByIdAndDelete(req.params.codeId);\r\n    res.status(204).json(deletedCode)\r\n}"],"file":"codes.controller.js"}